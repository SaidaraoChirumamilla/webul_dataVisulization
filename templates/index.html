<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webull Visualization Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-5px);
        }

        .chart-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
            padding: 50px;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .refresh-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .metrics-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-label {
            font-size: 1em;
            color: #666;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .metric-value.positive {
            color: #10b981;
        }

        .metric-value.negative {
            color: #ef4444;
        }

        .tabs-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .tab-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: white;
            color: #667eea;
            border-color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .filters-wrapper {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px 24px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(8px);
        }

        .filters-title {
            text-align: center;
            color: #333;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .filters-title::before,
        .filters-title::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(to right, transparent, #667eea, transparent);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            align-items: end;
        }
        .autocomplete-container { position: relative; }
        .autocomplete-list {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: #fff;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            z-index: 1000;
            max-height: 220px;
            overflow-y: auto;
            display: none;
        }
        .autocomplete-item { padding: 10px 12px; cursor: pointer; }
        .autocomplete-item:hover { background: #f3f4f6; }
        .clear-btn {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            background: transparent; border: none; color: #9ca3af;
            padding: 4px 8px; border-radius: 50%; cursor: pointer; font-size: 14px;
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
        }
        .clear-btn:hover { 
            background: #f3f4f6; 
            color: #6b7280;
        }
        .clear-btn:active {
            background: #e5e7eb;
        }

        .metric-tooltip {
            position: relative;
            cursor: help;
        }

        .metric-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            margin-bottom: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .metric-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1f2937;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1001;
            margin-bottom: 2px;
        }

        .metric-tooltip:hover::after,
        .metric-tooltip:hover::before {
            opacity: 1;
            visibility: visible;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            color: #555;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .filter-label::before {
            content: 'üîç';
            font-size: 1.1em;
        }

        .filter-select {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            font-size: 0.95em;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
            height: 42px;
        }

        .filter-select:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-select option {
            padding: 10px;
            background: white;
        }

        .clear-filters-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            align-self: end;
            height: 42px;
        }

        .clear-filters-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .clear-filters-btn:active {
            transform: translateY(0);
        }

        .view-container {
            display: none;
        }

        .view-container.active {
            display: block;
        }

        /* Comparison mode: show both views side-by-side */
        .comparison-mode #views-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        .comparison-mode #view-trends,
        .comparison-mode #view-orders {
            display: block;
        }

        /* Section cards for View 2 */
        .section-card {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 24px;
        }
        .section-title {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 12px;
        }
        .responsive-table { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .orders-table thead th { cursor: pointer; user-select: none; }
        .orders-table tbody tr:hover { background: #f9fafb; }
        .orders-table th, .orders-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .orders-table th[aria-sort="ascending"]::after { content: ' \25B2'; }
        .orders-table th[aria-sort="descending"]::after { content: ' \25BC'; }
        @media (max-width: 768px) { .section-card { padding: 16px; } }

        /* Orders Dashboard Styles */
        .orders-dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Filters Section */
        .filters-section {
            background: white;
            border-radius: 15px;
            padding: 20px 24px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .filters-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-size: 0.75em;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .symbol-input, .status-select {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9em;
            transition: all 0.3s ease;
            background: white;
        }

        .symbol-input:focus, .status-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Autocomplete Container */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.9em;
        }

        .autocomplete-item:hover {
            background-color: #f3f4f6;
        }

        .autocomplete-item.active {
            background-color: #667eea;
            color: white;
        }

        /* Clear Button */
        .clear-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            transition: all 0.3s ease;
            line-height: 1;
            padding: 0;
        }

        .clear-btn:hover {
            background: #5a67d8;
            transform: translateY(-50%) scale(1.1);
        }

        .clear-btn.visible {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* KPI Section */
        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .kpi-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            transition: transform 0.3s ease;
            position: relative;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        /* Tooltip */
        .kpi-label[data-tooltip] {
            position: relative;
            cursor: help;
        }

        .kpi-label[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75em;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
            opacity: 0;
            animation: tooltipFadeIn 0.3s ease forwards;
        }

        .kpi-label[data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #333;
            margin-bottom: 0;
            opacity: 0;
            animation: tooltipFadeIn 0.3s ease forwards;
        }

        @keyframes tooltipFadeIn {
            to {
                opacity: 1;
            }
        }

        /* Enhanced Company Filter Component Styles */
        .company-filter-container {
            width: 100%;
            max-width: 400px;
        }

        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .company-dropdown-container {
            position: relative;
            width: 100%;
        }

        .company-search-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .company-search-wrapper:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .company-search-wrapper:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .company-search-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            font-size: 0.95em;
            color: #333;
            outline: none;
            min-width: 0;
        }

        .company-search-input::placeholder {
            color: #9ca3af;
            font-weight: 400;
        }

        .company-clear-btn {
            background: transparent;
            border: none;
            color: #9ca3af;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-right: 4px;
        }

        .company-clear-btn:hover {
            background: #f3f4f6;
            color: #6b7280;
        }

        .company-clear-btn:active {
            background: #e5e7eb;
        }

        .dropdown-toggle {
            background: transparent;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-left: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .dropdown-toggle:hover {
            background: #f9fafb;
        }

        .dropdown-arrow {
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 6px solid #6b7280;
            transition: transform 0.2s ease;
        }

        .dropdown-toggle.active .dropdown-arrow {
            transform: rotate(180deg);
            border-top-color: #667eea;
        }

        .company-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 400px;
            overflow: hidden;
            display: none;
            margin-top: 4px;
        }

        .company-dropdown.active {
            display: block;
            animation: dropdownSlideIn 0.2s ease-out;
        }

        @keyframes dropdownSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px 12px;
            border-bottom: 1px solid #f3f4f6;
        }

        .dropdown-title {
            font-weight: 600;
            color: #374151;
            font-size: 0.95em;
        }

        .dropdown-count {
            font-size: 0.8em;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .dropdown-search {
            padding: 12px 20px;
            border-bottom: 1px solid #f3f4f6;
        }

        .dropdown-search-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9em;
            outline: none;
            transition: all 0.2s ease;
        }

        .dropdown-search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .dropdown-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: #6b7280;
            font-size: 0.9em;
            gap: 12px;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .dropdown-content {
            max-height: 250px;
            overflow-y: auto;
            padding: 8px 0;
        }

        .dropdown-content::-webkit-scrollbar {
            width: 6px;
        }

        .dropdown-content::-webkit-scrollbar-track {
            background: #f3f4f6;
        }

        .dropdown-content::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .dropdown-content::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .company-option {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .company-option:hover {
            background: #f9fafb;
            border-left-color: #667eea;
        }

        .company-option.selected {
            background: #eef2ff;
            border-left-color: #667eea;
        }

        .company-option.keyboard-selected {
            background: #f3f4f6;
            border-left-color: #9ca3af;
        }

        .company-checkbox {
            width: 16px;
            height: 16px;
            margin-right: 12px;
            border: 2px solid #d1d5db;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .company-option.selected .company-checkbox {
            background: #667eea;
            border-color: #667eea;
        }

        .company-option.selected .company-checkbox::after {
            content: '‚úì';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .company-info {
            flex: 1;
            min-width: 0;
        }

        .company-name {
            font-weight: 500;
            color: #374151;
            font-size: 0.9em;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .company-symbol {
            color: #6b7280;
            font-size: 0.8em;
            font-weight: 500;
        }

        .company-sector {
            color: #9ca3af;
            font-size: 0.75em;
            margin-top: 2px;
        }

        .dropdown-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-top: 1px solid #f3f4f6;
            background: #f9fafb;
        }

        .dropdown-clear-btn, .dropdown-apply-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dropdown-clear-btn {
            background: white;
            color: #6b7280;
            border: 1px solid #d1d5db;
        }

        .dropdown-clear-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .dropdown-apply-btn {
            background: #667eea;
            color: white;
        }

        .dropdown-apply-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
            font-size: 0.9em;
        }

        /* Responsive Design for Company Filter */
        @media (max-width: 768px) {
            .company-filter-container {
                max-width: 100%;
            }
            
            .company-dropdown {
                max-height: 300px;
            }
            
            .dropdown-content {
                max-height: 200px;
            }
            
            .dropdown-header, .dropdown-footer {
                padding: 12px 16px;
            }
            
            .company-option {
                padding: 10px 16px;
            }
        }

        @media (max-width: 480px) {
            .company-search-input {
                padding: 10px 12px;
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            .company-dropdown {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                max-height: none;
                border-radius: 0;
                margin: 0;
            }
            
            .dropdown-footer {
                position: sticky;
                bottom: 0;
                background: white;
            }
        }

        /* Accessibility for Company Filter */
        .company-option:focus {
            outline: 2px solid #667eea;
            outline-offset: -2px;
        }

        .company-search-input:focus,
        .dropdown-search-input:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        /* High contrast mode support for Company Filter */
        @media (prefers-contrast: high) {
            .company-dropdown {
                border: 2px solid #000;
            }
            
            .company-option:hover {
                background: #000;
                color: #fff;
            }
        }

        /* Reduced motion support for Company Filter */
        @media (prefers-reduced-motion: reduce) {
            .company-dropdown,
            .company-option,
            .dropdown-apply-btn {
                animation: none;
                transition: none;
            }
        }

        /* Orders Tables */
        .orders-tables {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .orders-table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .table-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .order-badge {
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            font-weight: 600;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
        }

        .orders-table th {
            background: #f9fafb;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #4b5563;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e5e7eb;
        }

        .orders-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
            font-size: 0.9em;
        }

        .orders-table tbody tr:hover {
            background: #f9fafb;
        }

        .no-data {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 40px 20px;
        }

        /* Tab Transitions */
        .view-container {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            display: none;
        }

        .view-container.active {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .kpi-section {
                grid-template-columns: 1fr;
            }
            
            .orders-tables {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .orders-dashboard {
                padding: 0 10px;
            }
            
            .filters-section {
                padding: 16px 20px;
                margin: 15px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .table-header {
                padding: 15px 20px;
            }
            
            .orders-table th,
            .orders-table td {
                padding: 10px 12px;
                font-size: 0.8em;
            }
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 300px;
            }

            .metrics-container {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .clear-filters-btn {
                align-self: stretch;
            }

            .filters-wrapper {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Webull Financial Dashboard</h1>
        <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
        <div id="loading" class="loading">Loading data from Google Sheets...</div>
        <div id="error" class="error" style="display: none;"></div>

        <!-- Tabs -->
        <div id="tabs" class="tabs-container" style="display: none;">
            <button class="tab-button active" onclick="switchView('trends')">Financial Flow Analysis</button>
            <button class="tab-button" onclick="switchView('orders')">Orders Dashboard</button>
            <button class="tab-button" onclick="togglePerformancePanel()">‚ö° Performance</button>
            <button class="tab-button" onclick="window.open('/tests', '_blank')">üß™ Unit Tests</button>
            <button class="tab-button" onclick="window.open('/e2e-tests', '_blank')">üîç E2E Tests</button>
        </div>

        <div id="views-wrapper">
        <!-- View 1: Overall Trends -->
        <div id="view-trends" class="view-container active">
            <!-- Summary Metrics -->
            <div id="metrics" class="metrics-container" style="display: none;">
                <div class="metric-card">
                    <div class="metric-label">Total Incoming (Completed)</div>
                    <div class="metric-value positive" id="total-incoming">$0.00</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Outgoing (Completed)</div>
                    <div class="metric-value negative" id="total-outgoing">$0.00</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Net Account Value</div>
                    <div class="metric-value" id="net-value">$0.00</div>
                </div>
            </div>
            <div id="charts" class="charts-grid" style="display: none;">
                <div class="chart-container">
                    <div class="chart-title">Monthly Cash Flow Analysis</div>
                    <div class="chart-wrapper">
                        <canvas id="monthlyCashFlowChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Yearly Transfer Volume Comparison</div>
                    <div class="chart-wrapper">
                        <canvas id="yearlyTransferChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Transaction Status Distribution</div>
                    <div class="chart-wrapper">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Transfer Volume by Type</div>
                    <div class="chart-wrapper">
                        <canvas id="transferTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- View 2: Orders Dashboard -->
        <div id="view-orders" class="view-container">
            <!-- Orders Dashboard Content -->
            <div class="orders-dashboard">
                <!-- Orders Filters Section -->
                <div class="filters-section">
                    <div class="filters-title">Filters</div>
                    <div class="filters-grid">
                        <!-- Enhanced Company Filter -->
                        <div class="filter-group">
                            <div id="company-filter-wrapper">
                                <!-- Enhanced Company Filter Component -->
                                <div class="company-filter-container">
                                    <div class="filter-section">
                                        <label class="filter-label" for="company-search">
                                            <span class="search-icon">üîç</span>
                                            STOCK COMPANY
                                        </label>
                                        <div class="company-dropdown-container">
                                            <div class="company-search-wrapper">
                                                <input 
                                                    type="text" 
                                                    id="company-search" 
                                                    class="company-search-input" 
                                                    placeholder="Search company..."
                                                    autocomplete="off"
                                                    aria-label="Search stock companies"
                                                    aria-expanded="false"
                                                    aria-controls="company-dropdown"
                                                >
                                                <button 
                                                    id="company-clear" 
                                                    class="company-clear-btn" 
                                                    type="button" 
                                                    aria-label="Clear company search"
                                                    style="display: none;"
                                                >‚úï</button>
                                                <button 
                                                    id="company-dropdown-toggle" 
                                                    class="dropdown-toggle" 
                                                    type="button"
                                                    aria-label="Toggle company dropdown"
                                                >
                                                    <span class="dropdown-arrow"></span>
                                                </button>
                                            </div>
                                            <div id="company-dropdown" class="company-dropdown" role="listbox" aria-label="Company options">
                                                <div class="dropdown-header">
                                                    <div class="dropdown-title">Select Company</div>
                                                    <div class="dropdown-count">
                                                        <span id="company-count">0</span> companies
                                                    </div>
                                                </div>
                                                <div class="dropdown-search">
                                                    <input 
                                                        type="text" 
                                                        id="dropdown-search-input" 
                                                        class="dropdown-search-input" 
                                                        placeholder="Type to filter companies..."
                                                        autocomplete="off"
                                                    >
                                                </div>
                                                <div class="dropdown-loading" id="company-loading" style="display: none;">
                                                    <div class="loading-spinner"></div>
                                                    <span>Loading companies...</span>
                                                </div>
                                                <div class="dropdown-content" id="company-dropdown-content">
                                                    <!-- Company options will be populated here -->
                                                </div>
                                                <div class="dropdown-footer">
                                                    <button id="clear-all-companies" class="dropdown-clear-btn">Clear Selection</button>
                                                    <button id="apply-companies" class="dropdown-apply-btn">Apply Filter</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">STATUS</label>
                            <select id="status-filter" class="status-select">
                                <option value="">All Status</option>
                                <option value="filled">Filled</option>
                                <option value="pending">Pending</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Orders KPI Section -->
                <div class="kpi-section">
                    <div class="kpi-card">
                        <div class="kpi-label" data-tooltip="Total value of all buy orders">TOTAL BOUGHT VALUE</div>
                        <div class="kpi-value" id="total-bought">$0.00</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label" data-tooltip="Total value of all sell orders">TOTAL SOLD VALUE</div>
                        <div class="kpi-value" id="total-sold">$0.00</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label" data-tooltip="Net profit from all orders">NET PROFIT</div>
                        <div class="kpi-value" id="net-profit">$0.00</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label" data-tooltip="Total number of orders">ORDERS COUNT</div>
                        <div class="kpi-value" id="orders-count">0</div>
                    </div>
                </div>

                <!-- Orders Tables Section -->
                <div class="orders-tables">
                    <div class="orders-table-container">
                        <div class="table-header">
                            <h3 class="table-title">Buy Orders</h3>
                            <span class="order-badge" id="buy-count">0</span>
                        </div>
                        <div class="table-wrapper">
                            <table class="orders-table" id="buy-orders-table">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Stock Name</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="buy-orders-tbody">
                                    <tr class="no-data">
                                        <td colspan="6">No buy orders found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="orders-table-container">
                        <div class="table-header">
                            <h3 class="table-title">Sell Orders</h3>
                            <span class="order-badge" id="sell-count">0</span>
                        </div>
                        <div class="table-wrapper">
                            <table class="orders-table" id="sell-orders-table">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Stock Name</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="sell-orders-tbody">
                                    <tr class="no-data">
                                        <td colspan="6">No sell orders found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Monitoring Panel (Hidden by default) -->
                <div id="performance-panel" style="display: none; margin-top: 30px; background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #333;">Performance Metrics</h3>
                        <button onclick="document.getElementById('performance-panel').style.display='none'" 
                                style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">Close</button>
                    </div>
                    <div id="performance-metrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <!-- Performance metrics will be populated here -->
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="DashboardState.clearCache()" 
                                style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">Clear Cache</button>
                        <button onclick="runPerformanceTests()" 
                                style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Run Tests</button>
                    </div>
                </div>
            </div>
        </div>
        </div><!-- end views-wrapper -->

            
        </div>
    </div>

    <script>
        let charts = {};
        let filterWorker = null;
        let lastFilter = { search: '', status: '', start: null, end: null };
        let lastFilteredBuy = [];
        let lastFilteredSell = [];
        let pageSize = 50;
        let buyPage = 1;
        let sellPage = 1;

        // Shared State Management
        const DashboardState = {
            currentView: 'trends',
            ordersData: { buy: [], sell: [], symbols: [] },
            financialData: null,
            sharedFilters: {
                symbol: '',
                status: '',
                dateRange: { start: null, end: null },
                companies: [] // Array of selected company symbols
            },
            isLoading: false,
            cache: new Map(), // Simple cache for API responses
            cacheTimeout: 5 * 60 * 1000, // 5 minutes cache timeout
            
            // Performance monitoring
            performanceMetrics: {
                apiCalls: 0,
                cacheHits: 0,
                cacheMisses: 0,
                renderTimes: [],
                loadTimes: []
            },
            
            // Initialize from localStorage
            init() {
                const saved = localStorage.getItem('dashboardState');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        this.currentView = parsed.currentView || 'trends';
                        this.sharedFilters = { ...this.sharedFilters, ...parsed.sharedFilters };
                    } catch (e) {
                        console.warn('Failed to load saved dashboard state:', e);
                    }
                }
                
                // Initialize performance monitoring
                this.startPerformanceMonitoring();
            },
            
            // Performance monitoring methods
            startPerformanceMonitoring() {
                // Monitor API calls
                const originalFetch = window.fetch;
                window.fetch = (...args) => {
                    const startTime = performance.now();
                    this.performanceMetrics.apiCalls++;
                    
                    return originalFetch(...args).then(response => {
                        const endTime = performance.now();
                        this.performanceMetrics.loadTimes.push(endTime - startTime);
                        return response;
                    });
                };
                
                // Monitor render performance
                this.addListener('viewChanged', () => {
                    const startTime = performance.now();
                    setTimeout(() => {
                        const endTime = performance.now();
                        this.performanceMetrics.renderTimes.push(endTime - startTime);
                    }, 300); // Wait for transition to complete
                });
            },
            
            getPerformanceReport() {
                const avgRenderTime = this.performanceMetrics.renderTimes.length > 0 
                    ? this.performanceMetrics.renderTimes.reduce((a, b) => a + b, 0) / this.performanceMetrics.renderTimes.length 
                    : 0;
                
                const avgLoadTime = this.performanceMetrics.loadTimes.length > 0 
                    ? this.performanceMetrics.loadTimes.reduce((a, b) => a + b, 0) / this.performanceMetrics.loadTimes.length 
                    : 0;
                
                const cacheHitRate = this.performanceMetrics.apiCalls > 0 
                    ? (this.performanceMetrics.cacheHits / this.performanceMetrics.apiCalls * 100).toFixed(2) 
                    : 0;
                
                return {
                    totalApiCalls: this.performanceMetrics.apiCalls,
                    cacheHitRate: `${cacheHitRate}%`,
                    cacheHits: this.performanceMetrics.cacheHits,
                    cacheMisses: this.performanceMetrics.cacheMisses,
                    averageRenderTime: `${avgRenderTime.toFixed(2)}ms`,
                    averageLoadTime: `${avgLoadTime.toFixed(2)}ms`,
                    renderCount: this.performanceMetrics.renderTimes.length
                };
            },
            
            // Persist state to localStorage
            saveState() {
                const stateToSave = {
                    currentView: this.currentView,
                    sharedFilters: this.sharedFilters,
                    timestamp: Date.now()
                };
                localStorage.setItem('dashboardState', JSON.stringify(stateToSave));
            },
            
            // State update methods
            setView(view) {
                this.currentView = view;
                this.saveState();
                this.notifyListeners('viewChanged', view);
            },
            
            setOrdersData(data) {
                this.ordersData = data;
                this.notifyListeners('ordersDataUpdated', data);
            },
            
            setFinancialData(data) {
                this.financialData = data;
                this.notifyListeners('financialDataUpdated', data);
            },
            
            updateFilters(filters) {
                this.sharedFilters = { ...this.sharedFilters, ...filters };
                this.saveState();
                this.notifyListeners('filtersUpdated', this.sharedFilters);
            },
            
            // Event system for state changes
            listeners: {},
            
            addListener(event, callback) {
                if (!this.listeners[event]) {
                    this.listeners[event] = [];
                }
                this.listeners[event].push(callback);
            },
            
            notifyListeners(event, data) {
                if (this.listeners[event]) {
                    this.listeners[event].forEach(callback => callback(data));
                }
            },
            
            // Data fetching with caching and deduplication
            async fetchOrdersData() {
                if (this.isLoading) return;
                
                // Check cache first
                const cacheKey = 'orders';
                const cached = this.cache.get(cacheKey);
                if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
                    console.log('Using cached orders data');
                    this.performanceMetrics.cacheHits++;
                    this.setOrdersData(cached.data);
                    return cached.data;
                }
                
                this.performanceMetrics.cacheMisses++;
                this.isLoading = true;
                this.notifyListeners('loadingStarted');
                
                try {
                    const response = await fetch('/api/orders');
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Cache the response
                    this.cache.set(cacheKey, {
                        data: data,
                        timestamp: Date.now()
                    });
                    
                    this.setOrdersData(data);
                    return data;
                } catch (error) {
                    console.error('Error fetching orders data:', error);
                    this.notifyListeners('error', error.message);
                } finally {
                    this.isLoading = false;
                    this.notifyListeners('loadingEnded');
                }
            },
            
            async fetchSymbols() {
                // Check cache first
                const cacheKey = 'symbols';
                const cached = this.cache.get(cacheKey);
                if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
                    console.log('Using cached symbols data');
                    this.performanceMetrics.cacheHits++;
                    this.ordersData.symbols = cached.data;
                    this.notifyListeners('symbolsUpdated', cached.data);
                    return cached.data;
                }
                
                this.performanceMetrics.cacheMisses++;
                
                try {
                    const response = await fetch('/api/orders/symbols');
                    const data = await response.json();
                    
                    if (data.symbols) {
                        // Cache the response
                        this.cache.set(cacheKey, {
                            data: data.symbols,
                            timestamp: Date.now()
                        });
                        
                        this.ordersData.symbols = data.symbols;
                        this.notifyListeners('symbolsUpdated', data.symbols);
                        return data.symbols;
                    }
                } catch (error) {
                    console.error('Error fetching symbols:', error);
                }
            },
            
            // Clear cache method
            clearCache() {
                this.cache.clear();
                console.log('Dashboard cache cleared');
            }
        };

        // Orders Dashboard Logic
        const OrdersDashboard = {
            currentFilters: { symbol: '', status: '' },
            filteredData: { buy: [], sell: [] },
            
            init() {
                this.restoreFilterState();
                this.setupEventListeners();
                this.setupAutocomplete();
                DashboardState.addListener('ordersDataUpdated', (data) => this.updateDisplay(data));
                DashboardState.addListener('filtersUpdated', (filters) => this.applyFilters(filters));
            },
            
            // Restore filter state from DashboardState/sharedFilters
            restoreFilterState() {
                const savedFilters = DashboardState.sharedFilters;
                
                // Restore symbol filter
                if (savedFilters.symbol) {
                    const symbolInput = document.getElementById('symbol-search');
                    const clearBtn = document.getElementById('symbol-clear');
                    if (symbolInput) {
                        symbolInput.value = savedFilters.symbol;
                        if (clearBtn) {
                            clearBtn.classList.add('visible');
                        }
                    }
                    this.currentFilters.symbol = savedFilters.symbol;
                }
                
                // Restore status filter
                if (savedFilters.status) {
                    const statusSelect = document.getElementById('status-filter');
                    if (statusSelect) {
                        statusSelect.value = savedFilters.status;
                    }
                    this.currentFilters.status = savedFilters.status;
                }
                
                console.log('Restored filter state:', this.currentFilters);
            },
            
            setupEventListeners() {
                const symbolSearch = document.getElementById('symbol-search');
                const symbolClear = document.getElementById('symbol-clear');
                const statusFilter = document.getElementById('status-filter');
                
                if (symbolSearch) {
                    symbolSearch.addEventListener('input', (e) => {
                        this.handleSymbolSearch(e.target.value);
                    });
                    
                    symbolSearch.addEventListener('keydown', (e) => {
                        this.handleAutocompleteKeydown(e);
                    });
                }
                
                if (symbolClear) {
                    symbolClear.addEventListener('click', () => {
                        this.clearSymbolFilter();
                    });
                }
                
                if (statusFilter) {
                    statusFilter.addEventListener('change', (e) => {
                        this.handleStatusFilter(e.target.value);
                    });
                }
            },
            
            setupAutocomplete() {
                const container = document.querySelector('.autocomplete-container');
                const input = document.getElementById('symbol-search');
                const dropdown = document.getElementById('symbol-autocomplete');
                
                if (!container || !input || !dropdown) return;
                
                let currentFocus = -1;
                
                input.addEventListener('input', () => {
                    const value = input.value.toLowerCase();
                    const symbols = DashboardState.ordersData.symbols || [];
                    
                    dropdown.innerHTML = '';
                    currentFocus = -1;
                    
                    if (value.length < 1) {
                        dropdown.style.display = 'none';
                        return;
                    }
                    
                    const matches = symbols.filter(symbol => 
                        symbol.toLowerCase().includes(value)
                    ).slice(0, 5);
                    
                    if (matches.length === 0) {
                        dropdown.style.display = 'none';
                        return;
                    }
                    
                    matches.forEach((symbol, index) => {
                        const item = document.createElement('div');
                        item.className = 'autocomplete-item';
                        item.textContent = symbol;
                        item.addEventListener('click', () => {
                            input.value = symbol;
                            dropdown.style.display = 'none';
                            this.handleSymbolSearch(symbol);
                        });
                        dropdown.appendChild(item);
                    });
                    
                    dropdown.style.display = 'block';
                });
                
                document.addEventListener('click', (e) => {
                    if (!container.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
            },
            
            handleSymbolSearch(value) {
                const clearBtn = document.getElementById('symbol-clear');
                if (clearBtn) {
                    clearBtn.classList.toggle('visible', value.length > 0);
                }
                
                this.currentFilters.symbol = value;
                DashboardState.updateFilters({ symbol: value });
                this.applyFilters(DashboardState.sharedFilters);
            },
            
            handleStatusFilter(status) {
                this.currentFilters.status = status;
                DashboardState.updateFilters({ status: status });
                this.applyFilters(DashboardState.sharedFilters);
            },
            
            clearSymbolFilter() {
                const input = document.getElementById('symbol-search');
                const clearBtn = document.getElementById('symbol-clear');
                const dropdown = document.getElementById('symbol-autocomplete');
                
                if (input) input.value = '';
                if (clearBtn) clearBtn.classList.remove('visible');
                if (dropdown) dropdown.style.display = 'none';
                
                this.currentFilters.symbol = '';
                DashboardState.updateFilters({ symbol: '' });
                this.applyFilters(DashboardState.sharedFilters);
            },
            
            applyFilters(filters) {
                const allOrders = DashboardState.ordersData;
                if (!allOrders.buy || !allOrders.sell) return;
                
                this.filteredData.buy = this.filterOrders(allOrders.buy, filters);
                this.filteredData.sell = this.filterOrders(allOrders.sell, filters);
                
                this.updateKPIs();
                this.updateTables();
                this.updateOrderCounts();
            },
            
            filterOrders(orders, filters) {
                return orders.filter(order => {
                    const symbolMatch = !filters.symbol || 
                        order.symbol.toLowerCase().includes(filters.symbol.toLowerCase());
                    
                    const statusMatch = !filters.status || 
                        order.status.toLowerCase() === filters.status.toLowerCase();
                    
                    // Company filter - check if order symbol is in selected companies
                    const companyMatch = !filters.companies || filters.companies.length === 0 || 
                        filters.companies.includes(order.symbol);
                    
                    return symbolMatch && statusMatch && companyMatch;
                });
            },
            
            updateKPIs() {
                const buyTotal = this.filteredData.buy.reduce((sum, order) => sum + order.total, 0);
                const sellTotal = this.filteredData.sell.reduce((sum, order) => sum + order.total, 0);
                const netProfit = sellTotal - buyTotal;
                
                document.getElementById('total-bought').textContent = this.formatCurrency(buyTotal);
                document.getElementById('total-sold').textContent = this.formatCurrency(sellTotal);
                document.getElementById('net-profit').textContent = this.formatCurrency(netProfit);
                
                const netProfitElement = document.getElementById('net-profit');
                netProfitElement.style.color = netProfit >= 0 ? '#10b981' : '#ef4444';
            },
            
            updateOrderCounts() {
                const totalOrders = this.filteredData.buy.length + this.filteredData.sell.length;
                document.getElementById('orders-count').textContent = totalOrders;
                document.getElementById('buy-count').textContent = this.filteredData.buy.length;
                document.getElementById('sell-count').textContent = this.filteredData.sell.length;
            },
            
            updateTables() {
                this.updateTable('buy-orders-tbody', this.filteredData.buy);
                this.updateTable('sell-orders-tbody', this.filteredData.sell);
            },
            
            updateTable(tbodyId, orders) {
                const tbody = document.getElementById(tbodyId);
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (orders.length === 0) {
                    const row = document.createElement('tr');
                    row.className = 'no-data';
                    row.innerHTML = `<td colspan="6">No ${tbodyId.includes('buy') ? 'buy' : 'sell'} orders found</td>`;
                    tbody.appendChild(row);
                    return;
                }
                
                orders.forEach(order => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${order.symbol}</td>
                        <td>${order.symbol}</td>
                        <td>${order.quantity}</td>
                        <td>${this.formatCurrency(order.price)}</td>
                        <td>${this.formatCurrency(order.total)}</td>
                        <td>${order.date || 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });
            },
            
            updateDisplay(data) {
                if (data && data.buy && data.sell) {
                    this.applyFilters(this.currentFilters);
                }
            },
            
            formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2
                }).format(amount);
            },
            
            handleAutocompleteKeydown(e) {
                const dropdown = document.getElementById('symbol-autocomplete');
                const items = dropdown.querySelectorAll('.autocomplete-item');
                let currentFocus = -1;
                
                if (e.keyCode === 40) {
                    currentFocus++;
                    this.addActive(items, currentFocus);
                } else if (e.keyCode === 38) {
                    currentFocus--;
                    this.addActive(items, currentFocus);
                } else if (e.keyCode === 13) {
                    e.preventDefault();
                    if (currentFocus > -1 && items[currentFocus]) {
                        items[currentFocus].click();
                    }
                } else if (e.keyCode === 27) {
                    dropdown.style.display = 'none';
                }
            },
            
            addActive(items, currentFocus) {
                if (!items) return false;
                this.removeActive(items);
                if (currentFocus >= items.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (items.length - 1);
                if (items[currentFocus]) {
                    items[currentFocus].classList.add('active');
                }
                return currentFocus;
            },
            
            removeActive(items) {
                for (let i = 0; i < items.length; i++) {
                    items[i].classList.remove('active');
                }
            }
        };

        async function loadData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const chartsDiv = document.getElementById('charts');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            chartsDiv.style.display = 'none';

            try {
                // Initialize DashboardState from localStorage
                DashboardState.init();
                
                // Only fetch financial data initially for faster initial load
                const financialResponse = await fetch('/api/data');
                const financialData = await financialResponse.json();

                if (financialData.error) {
                    throw new Error(financialData.error);
                }

                loading.style.display = 'none';
                document.getElementById('tabs').style.display = 'flex';
                
                // Store financial data in shared state
                DashboardState.setFinancialData(financialData);
                
                // Display summary metrics
                displayMetrics(financialData.summary_metrics);
                
                // Initialize orders dashboard (will restore filter state)
                OrdersDashboard.init();
                
                // Show charts for active view
                createCharts(financialData);
                
                // Store in window for backward compatibility
                window.currentData = financialData;
                
                // Load orders data in background (lazy loading)
                // This won't block the initial page render
                setTimeout(() => {
                    DashboardState.fetchOrdersData().then(() => {
                        // Fetch symbols for autocomplete after orders data is loaded
                        DashboardState.fetchSymbols();
                    });
                }, 1000); // 1 second delay to prioritize initial render
                
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = `Error: ${err.message}`;
                console.error('Error loading data:', err);
            }
        }

        function formatCurrency(value) {
            const sign = value >= 0 ? '+' : '';
            return `${sign}$${Math.abs(value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        function displayMetrics(metrics) {
            const metricsDiv = document.getElementById('metrics');
            if (!metrics) {
                metricsDiv.style.display = 'none';
                return;
            }

            metricsDiv.style.display = 'grid';
            
            const totalIncoming = document.getElementById('total-incoming');
            const totalOutgoing = document.getElementById('total-outgoing');
            const netValue = document.getElementById('net-value');

            totalIncoming.textContent = formatCurrency(metrics.total_incoming_completed);
            totalOutgoing.textContent = formatCurrency(-metrics.total_outgoing_completed);
            
            netValue.textContent = formatCurrency(metrics.net_account_value);
            netValue.className = 'metric-value ' + (metrics.net_account_value >= 0 ? 'positive' : 'negative');
        }

        function switchView(viewName) {
            // Update shared state
            DashboardState.setView(viewName);
            
            // Update UI
            const buttons = document.querySelectorAll('.tabs-container .tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Activate appropriate button
            if (viewName === 'trends' && buttons[0]) buttons[0].classList.add('active');
            if (viewName === 'orders' && buttons[1]) buttons[1].classList.add('active');
            
            // Handle view containers with smooth transitions
            document.querySelectorAll('.view-container').forEach(view => {
                view.classList.remove('active');
            });
            
            document.body.classList.remove('comparison-mode');
            
            if (viewName === 'compare') {
                document.body.classList.add('comparison-mode');
                document.getElementById('view-trends').classList.add('active');
                document.getElementById('view-orders').classList.add('active');
                if (window.currentData) { createCharts(window.currentData, 'compare'); }
                return;
            }
            
            const selectedView = document.getElementById(`view-${viewName}`);
            if (selectedView) {
                // Add a small delay for smooth transition
                setTimeout(() => {
                    selectedView.classList.add('active');
                }, 50);
            }
            
            // Refresh charts if needed
            if (viewName === 'trends' && window.currentData) {
                createCharts(window.currentData);
            }
            
            // Lazy load orders data if switching to orders view
            if (viewName === 'orders' && DashboardState.ordersData.buy.length === 0) {
                DashboardState.fetchOrdersData();
            }
            
            // Initialize company filter when switching to orders view
            if (viewName === 'orders') {
                // Initialize the company filter
                setTimeout(() => {
                    initializeCompanyFilter();
                }, 100);
            }
        }

        // Make switchView accessible globally
        window.switchView = switchView;

        // Performance monitoring functions
        function togglePerformancePanel() {
            const panel = document.getElementById('performance-panel');
            if (panel.style.display === 'none') {
                updatePerformanceMetrics();
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        function updatePerformanceMetrics() {
            const metrics = DashboardState.getPerformanceReport();
            const container = document.getElementById('performance-metrics');
            
            container.innerHTML = `
                <div style="background: #f3f4f6; padding: 15px; border-radius: 8px;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">API Performance</div>
                    <div style="font-size: 0.9em; color: #6b7280;">Total Calls: ${metrics.totalApiCalls}</div>
                    <div style="font-size: 0.9em; color: #6b7280;">Cache Hit Rate: ${metrics.cacheHitRate}</div>
                    <div style="font-size: 0.9em; color: #6b7280;">Avg Load Time: ${metrics.averageLoadTime}</div>
                </div>
                <div style="background: #f3f4f6; padding: 15px; border-radius: 8px;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">Render Performance</div>
                    <div style="font-size: 0.9em; color: #6b7280;">Render Count: ${metrics.renderCount}</div>
                    <div style="font-size: 0.9em; color: #6b7280;">Avg Render Time: ${metrics.averageRenderTime}</div>
                </div>
                <div style="background: #f3f4f6; padding: 15px; border-radius: 8px;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">Cache Statistics</div>
                    <div style="font-size: 0.9em; color: #6b7280;">Cache Hits: ${metrics.cacheHits}</div>
                    <div style="font-size: 0.9em; color: #6b7280;">Cache Misses: ${metrics.cacheMisses}</div>
                </div>
            `;
        }

        function runPerformanceTests() {
            console.log('Running performance tests...');
            const startTime = performance.now();
            
            // Test 1: View switching performance
            const viewSwitchStart = performance.now();
            switchView('orders');
            setTimeout(() => {
                switchView('trends');
                const viewSwitchEnd = performance.now();
                console.log(`View switch test completed in ${viewSwitchEnd - viewSwitchStart}ms`);
                
                // Test 2: Filter performance
                const filterStart = performance.now();
                DashboardState.updateFilters({ symbol: 'AAPL' });
                setTimeout(() => {
                    DashboardState.updateFilters({ symbol: '' });
                    const filterEnd = performance.now();
                    console.log(`Filter test completed in ${filterEnd - filterStart}ms`);
                    
                    // Test 3: Cache performance
                    const cacheStart = performance.now();
                    DashboardState.clearCache();
                    DashboardState.fetchOrdersData().then(() => {
                        const cacheEnd = performance.now();
                        console.log(`Cache test completed in ${cacheEnd - cacheStart}ms`);
                        
                        const totalEnd = performance.now();
                        console.log(`All performance tests completed in ${totalEnd - startTime}ms`);
                        
                        // Update metrics display
                        updatePerformanceMetrics();
                        
                        alert(`Performance tests completed!\nTotal time: ${(totalEnd - startTime).toFixed(2)}ms\nCheck console for detailed results.`);
                    });
                }, 100);
            }, 100);
        }

        function clearFilters() {
            const stockSearch = document.getElementById('stock-search');
            const stockAutocomplete = document.getElementById('stock-autocomplete');
            let autocompleteTimer;
            const statusFilter = document.getElementById('status-filter');
            const dateRange = document.getElementById('date-range');
            const quickRange = document.getElementById('quick-range');
            stockSearch.value = '';
            statusFilter.value = '';
            if (dateRange) dateRange.value = '';
            if (quickRange) quickRange.value = '';
            buyPage = 1;
            sellPage = 1;
            lastFilter = { search: '', status: '', start: null, end: null };
            localStorage.setItem('wb:filters', JSON.stringify(lastFilter));
            applyFiltersWithWorker();
        }

        function createCharts(data, mode) {
            console.log('createCharts called with mode:', mode, 'data available:', !!data);
            // Store data globally
            window.currentData = data;
            
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
            
            // Get active view
            const activeView = document.querySelector('.view-container.active');
            console.log('Active view:', activeView ? activeView.id : 'none');
            if (!activeView) return;
            
            if (mode === 'compare') {
                createTrendsCharts(data);
                createOrderAnalysisCharts(data);
                return;
            }
            const viewId = activeView.id;
            console.log('Processing viewId:', viewId);
            if (viewId === 'view-trends') {
                createTrendsCharts(data);
            } else if (viewId === 'view-orders') {
                // View 2 is now loaded via iframe, no need to create charts here
                console.log('View 2 (Orders) loaded via iframe');
            }
        }

        function createTrendsCharts(data) {
            const chartsDiv = document.getElementById('charts');
            chartsDiv.style.display = 'grid';

            // Monthly Cash Flow Chart
            const monthlyCtx = document.getElementById('monthlyCashFlowChart').getContext('2d');
            charts.monthly = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: data.monthly_cash_flow.months,
                    datasets: [
                        {
                            label: 'Incoming',
                            data: data.monthly_cash_flow.incoming,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Outgoing',
                            data: data.monthly_cash_flow.outgoing,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Net Flow',
                            data: data.monthly_cash_flow.net_flow,
                            type: 'line',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Amount ($)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year-Month'
                            }
                        }
                    }
                }
            });

            // Yearly Transfer Volume Chart
            const yearlyCtx = document.getElementById('yearlyTransferChart').getContext('2d');
            charts.yearly = new Chart(yearlyCtx, {
                type: 'bar',
                data: {
                    labels: data.yearly_transfer_volume.years,
                    datasets: [
                        {
                            label: 'Incoming',
                            data: data.yearly_transfer_volume.incoming,
                            backgroundColor: 'rgba(75, 192, 192, 0.8)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Outgoing',
                            data: data.yearly_transfer_volume.outgoing,
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount'
                            }
                        }
                    }
                }
            });

            // Transaction Status Distribution (Donut Chart)
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            charts.status = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: data.transaction_status.labels,
                    datasets: [{
                        data: data.transaction_status.values,
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(75, 192, 192, 0.5)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Transfer Volume by Type (Horizontal Bar Chart)
            const transferTypeCtx = document.getElementById('transferTypeChart').getContext('2d');
            charts.transferType = new Chart(transferTypeCtx, {
                type: 'bar',
                data: {
                    labels: data.transfer_by_type.types,
                    datasets: [{
                        label: 'Amount ($)',
                        data: data.transfer_by_type.amounts,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Amount: $${context.parsed.x.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount ($)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Type'
                            }
                        }
                    }
                }
            });
        }

        // DEPRECATED: View 2 now uses iframe - this function is no longer called
        function createOrderAnalysisCharts(data) {
            console.log('createOrderAnalysisCharts called with data:', data);
            const orderAnalysis = data.order_analysis || {};
            const ordersList = data.orders_list || [];
            
            // Display KPIs
            const kpiDiv = document.getElementById('order-kpi');
            
            // Total Profits KPI
            const profitValue = document.getElementById('total-profit');
            const totalProfit = orderAnalysis.total_profit || 0;
            profitValue.textContent = formatCurrency(totalProfit);
            profitValue.className = 'metric-value ' + (totalProfit >= 0 ? 'positive' : 'negative');
            
            // Bought Total Value KPI
            const boughtValue = document.getElementById('bought-total-value');
            const totalBought = orderAnalysis.total_value_bought || 0;
            boughtValue.textContent = formatCurrency(totalBought);
            boughtValue.className = 'metric-value';
            
            // Sell Total Value KPI
            const sellValue = document.getElementById('sell-total-value');
            const totalSold = orderAnalysis.total_value_sold || 0;
            sellValue.textContent = formatCurrency(totalSold);
            sellValue.className = 'metric-value';

            
            kpiDiv.style.display = 'grid';
            
            // Fix order count calculation
            const ordersCount = document.getElementById('orders-count');
            const totalOrders = (orderAnalysis.buy_orders || []).length + (orderAnalysis.sell_orders || []).length;
            ordersCount.textContent = String(totalOrders);

            

            // Build symbol -> name mapping for Stock Name resolution
            window.symbolNameMap = {};
            try {
                ordersList.forEach(o => {
                    const sym = o.symbol || o.Symbol;
                    const name = o.customer || o.Name;
                    if (sym && name && !window.symbolNameMap[sym]) {
                        window.symbolNameMap[sym] = String(name);
                    }
                });
            } catch {}
            
            // Setup filters
            const filtersContainer = document.getElementById('filters-container');
            const statusFilter = document.getElementById('status-filter');
            const stockSymbols = orderAnalysis.stock_symbols || [];
            const statuses = orderAnalysis.statuses || [];
            
            // Populate status filter dropdown
            statusFilter.innerHTML = '<option value="">All Statuses</option>';
            statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusFilter.appendChild(option);
            });
            
            filtersContainer.style.display = 'block';
            
            const stockList = document.getElementById('stock-list');
            const uniqueSymbols = [...new Set(orderAnalysis.buy_orders.map(o => o.symbol).concat(orderAnalysis.sell_orders.map(o => o.symbol)))];
            uniqueSymbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                stockList.appendChild(option);
            });

            // Display initial order data
            console.log('Initial order data:', orderAnalysis);
            console.log('Buy orders:', orderAnalysis.buy_orders ? orderAnalysis.buy_orders.length : 0);
            console.log('Sell orders:', orderAnalysis.sell_orders ? orderAnalysis.sell_orders.length : 0);
            displayOrderTables(orderAnalysis, '', '');
            const stockSearch = document.getElementById('stock-search');
            const dateRange = document.getElementById('date-range');

            flatpickr(dateRange, { mode: 'range' });
            const persist = () => localStorage.setItem('wb:filters', JSON.stringify(lastFilter));
            const restore = () => {
                const v = localStorage.getItem('wb:filters');
                if (v) {
                    try {
                        const obj = JSON.parse(v);
                        lastFilter = Object.assign(lastFilter, obj);
                        stockSearch.value = lastFilter.search || '';
                        statusFilter.value = lastFilter.status || '';
                    } catch {}
                }
            };
            restore();

            statusFilter.onchange = function() {
                lastFilter.status = this.value || '';
                persist();
                applyFiltersWithWorker();
            };
            stockSearch.onkeyup = function() {
                lastFilter.search = this.value || '';
                persist();
                applyFiltersWithWorker();
            };

            stockSearch.addEventListener('input', function(e) {
                const q = (e.target.value || '').trim();
                clearTimeout(autocompleteTimer);
                if (q.length === 0) { stockAutocomplete.style.display = 'none'; return; }
                autocompleteTimer = setTimeout(() => {
                    const list = (window.availableSymbols || []).filter(s => s.toLowerCase().includes(q.toLowerCase())).slice(0, 10);
                    if (list.length === 0) { stockAutocomplete.style.display = 'none'; return; }
                    stockAutocomplete.innerHTML = list.map(s => `<div class="autocomplete-item" data-symbol="${s}">${s}</div>`).join('');
                    stockAutocomplete.style.display = 'block';
                }, 200);
            });

            stockAutocomplete.addEventListener('click', function(e) {
                if (e.target.classList.contains('autocomplete-item')) {
                    const sym = e.target.getAttribute('data-symbol') || '';
                    stockSearch.value = sym;
                    stockAutocomplete.style.display = 'none';
                    lastFilter.search = sym;
                    persist();
                    applyFiltersWithWorker();
                }
            });

            document.addEventListener('click', function(e) {
                if (!stockSearch.contains(e.target) && !stockAutocomplete.contains(e.target)) {
                    stockAutocomplete.style.display = 'none';
                }
            });

            document.getElementById('stock-clear').addEventListener('click', function() {
                stockSearch.value = '';
                stockAutocomplete.style.display = 'none';
                lastFilter.search = '';
                persist();
                applyFiltersWithWorker();
            });
            dateRange.onchange = function() {
                const parts = (this.value || '').split(' to ');
                lastFilter.start = parts[0] || null;
                lastFilter.end = parts[1] || null;
                persist();
                applyFiltersWithWorker();
            };

            attachSortHandlers();
            updateSortHeaders('buy-orders-table', buySortKey, buySortDir);
            updateSortHeaders('sell-orders-table', sellSortKey, sellSortDir);
            applyFiltersWithWorker();
            document.getElementById('order-tables').style.display = 'block';
            const refreshBtn = document.getElementById('refresh-prices');
            refreshBtn.onclick = async function() {
                let positions = [];
                try {
                    const r = await fetch('/api/positions');
                    const j = await r.json();
                    positions = (j.positions || []).map(p => ({ symbol: p.symbol, quantity: p.quantity || 0, costBasis: p.cost_basis || p.costBasis || 0 }));
                } catch {}
                if (!positions || positions.length === 0) {
                    positions = calculatePositions(orderAnalysis);
                }
                const symbols = positions.map(p => p.symbol).filter(Boolean);
                if (symbols.length === 0) { renderPositions(positions, {}); return; }
                try {
                    const resp = await fetch(`/api/quotes?symbols=${encodeURIComponent(symbols.join(','))}`);
                    const q = await resp.json();
                    const quotes = q.quotes || {};
                    renderPositions(positions, quotes);
                } catch {
                    renderPositions(positions, {});
                }
            };


            const prevBuy = document.getElementById('prev-buy');
            const nextBuy = document.getElementById('next-buy');
            const prevSell = document.getElementById('prev-sell');
            const nextSell = document.getElementById('next-sell');
            prevBuy.onclick = function(){ if (buyPage > 1) { buyPage--; applyFiltersWithWorker(); } };
            nextBuy.onclick = function(){ buyPage++; applyFiltersWithWorker(); };
            prevSell.onclick = function(){ if (sellPage > 1) { sellPage--; applyFiltersWithWorker(); } };
            nextSell.onclick = function(){ sellPage++; applyFiltersWithWorker(); };
            const exportCsvBtn = document.getElementById('export-csv');
            const exportXlsxBtn = document.getElementById('export-xlsx');
            const exportPdfBtn = document.getElementById('export-pdf');
            exportCsvBtn.onclick = function() {
                const rows = [...lastFilteredBuy, ...lastFilteredSell];
                const headers = ['symbol','type','price','quantity','total_value','profit','date','status'];
                const csv = [headers.join(',')].concat(rows.map(r => headers.map(h => JSON.stringify(r[h] ?? '')).join(','))).join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'orders.csv'; a.click(); URL.revokeObjectURL(url);
            };
            exportXlsxBtn.onclick = function() {
                const rows = [...lastFilteredBuy, ...lastFilteredSell];
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Orders');
                XLSX.writeFile(wb, 'orders.xlsx');
            };
            exportPdfBtn.onclick = async function() {
                const el = document.getElementById('order-tables');
                const canvas = await html2canvas(el);
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save('orders.pdf');
            };
        }

        function renderFilteredTables(filteredBuyOrders, filteredSellOrders, totals) {
            console.log('renderFilteredTables called with:', filteredBuyOrders.length, filteredSellOrders.length);
            const filteredTotalBought = totals.totalBought || 0;
            const filteredTotalSold = totals.totalSold || 0;
            const filteredTotalProfit = totals.totalProfit || 0;
            const profitValue = document.getElementById('total-profit');
            const boughtValue = document.getElementById('bought-total-value');
            const sellValue = document.getElementById('sell-total-value');
            const ordersCount = document.getElementById('orders-count');
            
            // Update KPIs with filtered totals
            profitValue.textContent = formatCurrency(filteredTotalProfit);
            profitValue.className = 'metric-value ' + (filteredTotalProfit >= 0 ? 'positive' : 'negative');
            boughtValue.textContent = formatCurrency(filteredTotalBought);
            sellValue.textContent = formatCurrency(filteredTotalSold);
            
            // Update order count dynamically based on filtered data
            const totalFilteredOrders = filteredBuyOrders.length + filteredSellOrders.length;
            ordersCount.textContent = String(totalFilteredOrders);
            console.log('Updated order count to:', totalFilteredOrders);
            const buyBody = document.getElementById('buy-orders-body');
            const buyStart = (buyPage - 1) * pageSize;
            const buySlice = filteredBuyOrders.slice(buyStart, buyStart + pageSize);
            const buyInfo = document.getElementById('buy-page-info');
            if (buyInfo) buyInfo.textContent = `Page ${buyPage}`;
            console.log('Updating buy table with', buySlice.length, 'orders');
            if (buySlice.length === 0) {
                console.log('No buy orders to display');
                buyBody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #999;">No buy orders found</td></tr>';
            } else {
                console.log('Rendering', buySlice.length, 'buy orders');
                buyBody.innerHTML = buySlice.map(order => {
                    const name = resolveStockName(order.symbol || '');
                    return `
                    <tr>
                        <td>${order.symbol || 'N/A'}</td>
                        <td>${name}</td>
                        <td style="text-align:right;">${(order.quantity || 0).toFixed(2)}</td>
                        <td style="text-align:right;">$${(order.price || 0).toFixed(2)}</td>
                        <td style="text-align:right;">$${(order.total_value || 0).toFixed(2)}</td>
                    </tr>
                `;
                }).join('');
            }
            const buyTotalQty = buySlice.reduce((s,o)=>s+(o.quantity||0),0);
            const buyTotalAmt = buySlice.reduce((s,o)=>s+(o.total_value||0),0);
            const buyQtyEl = document.getElementById('buy-total-qty');
            const buyAmtEl = document.getElementById('buy-total-amount');
            if (buyQtyEl) buyQtyEl.textContent = buyTotalQty.toFixed(2);
            if (buyAmtEl) buyAmtEl.textContent = formatCurrency(buyTotalAmt);
            const sellBody = document.getElementById('sell-orders-body');
            const sellStart = (sellPage - 1) * pageSize;
            const sellSlice = filteredSellOrders.slice(sellStart, sellStart + pageSize);
            const sellInfo = document.getElementById('sell-page-info');
            if (sellInfo) sellInfo.textContent = `Page ${sellPage}`;
            console.log('Updating sell table with', sellSlice.length, 'orders');
            if (sellSlice.length === 0) {
                console.log('No sell orders to display');
                sellBody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #999;">No sell orders found</td></tr>';
            } else {
                console.log('Rendering', sellSlice.length, 'sell orders');
                sellBody.innerHTML = sellSlice.map(order => {
                    const name = resolveStockName(order.symbol || '');
                    return `
                    <tr>
                        <td>${order.symbol || 'N/A'}</td>
                        <td>${name}</td>
                        <td style="text-align:right;">${(order.quantity || 0).toFixed(2)}</td>
                        <td style="text-align:right;">$${(order.price || 0).toFixed(2)}</td>
                        <td style="text-align:right;">$${(order.total_value || 0).toFixed(2)}</td>
                    </tr>
                `;
                }).join('');
            }
            const sellTotalQty = sellSlice.reduce((s,o)=>s+(o.quantity||0),0);
            const sellTotalAmt = sellSlice.reduce((s,o)=>s+(o.total_value||0),0);
            const sellQtyEl = document.getElementById('sell-total-qty');
            const sellAmtEl = document.getElementById('sell-total-amount');
            if (sellQtyEl) sellQtyEl.textContent = sellTotalQty.toFixed(2);
            if (sellAmtEl) sellAmtEl.textContent = formatCurrency(sellTotalAmt);
        }

        function renderOrderMetrics(metrics, topSymbols) {
            const ordersCount = document.getElementById('orders-count');
            const trades = (metrics && metrics.trades) || 0;
            ordersCount.textContent = String(trades);
            const ctx = document.getElementById('topSymbolsChart').getContext('2d');
            if (charts.topSymbols) charts.topSymbols.destroy();
            const labels = (topSymbols || []).map(t => t.symbol);
            const dataVals = (topSymbols || []).map(t => t.volume);
            charts.topSymbols = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Volume', data: dataVals, backgroundColor: 'rgba(102,126,234,0.6)' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function renderOrdersList(orders) {
            const listLoading = document.getElementById('orders-loading');
            const listEmpty = document.getElementById('orders-empty');
            const listTable = document.getElementById('orders-list-table');
            const body = document.getElementById('orders-list-body');
            listLoading.style.display = 'none';
            if (!orders || orders.length === 0) {
                listEmpty.style.display = 'block';
                listTable.style.display = 'none';
                body.innerHTML = '';
                return;
            }
            listEmpty.style.display = 'none';
            listTable.style.display = 'table';
            body.innerHTML = orders.map(o => {
                const amt = `$${(o.total || 0).toFixed(2)}`;
                return `
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding:10px;font-weight:500;">${o.id || 'N/A'}</td>
                        <td style="padding:10px;">${o.customer || 'N/A'}</td>
                        <td style="padding:10px;">${formatDate(o.date || '')}</td>
                        <td style="padding:10px;">${o.status || 'N/A'}</td>
                        <td style="padding:10px;text-align:right;">${amt}</td>
                        <td style="padding:10px;text-align:center;">
                            <button class="clear-filters-btn" data-action="view" data-id="${o.id}">View</button>
                            <button class="clear-filters-btn" data-action="cancel" data-id="${o.id}">Cancel</button>
                        </td>
                    </tr>
                `;
            }).join('');
            body.querySelectorAll('button').forEach(btn => {
                btn.onclick = function(){
                    const action = this.getAttribute('data-action');
                    const id = this.getAttribute('data-id');
                    if (action === 'view') {
                        alert(`Order ${id}`);
                    } else if (action === 'cancel') {
                        alert(`Cancel ${id}`);
                    }
                };
            });
        }

        function resolveStockName(symbol) {
            if (!symbol) return 'N/A';
            const map = window.symbolNameMap || {};
            if (map[symbol]) return map[symbol];
            return symbol; // fallback
        }

        let buySortKey = 'symbol';
        let buySortDir = 'asc';
        let sellSortKey = 'symbol';
        let sellSortDir = 'asc';

        function sortOrders(arr, key, dir) {
            const getVal = (o) => {
                if (key === 'name') return resolveStockName(o.symbol || '');
                if (key === 'quantity') return o.quantity || 0;
                if (key === 'price') return o.price || 0;
                if (key === 'total') return o.total_value || 0;
                return (o.symbol || '').toUpperCase();
            };
            const mult = dir === 'desc' ? -1 : 1;
            return [...arr].sort((a,b) => {
                const va = getVal(a); const vb = getVal(b);
                if (typeof va === 'string' && typeof vb === 'string') return va.localeCompare(vb) * mult;
                return (va - vb) * mult;
            });
        }

        function updateSortHeaders(tableId, key, dir) {
            const thead = document.querySelector(`#${tableId} thead`);
            if (!thead) return;
            thead.querySelectorAll('th').forEach(th => th.setAttribute('aria-sort', 'none'));
            const active = thead.querySelector(`th[data-sort-key="${key}"]`);
            if (active) active.setAttribute('aria-sort', dir === 'desc' ? 'descending' : 'ascending');
        }

        function attachSortHandlers() {
            const buyThead = document.querySelector('#buy-orders-table thead');
            const sellThead = document.querySelector('#sell-orders-table thead');
            if (buyThead) buyThead.querySelectorAll('th').forEach(th => {
                th.onclick = function() {
                    const key = this.getAttribute('data-sort-key');
                    if (!key) return;
                    buySortDir = (buySortKey === key && buySortDir === 'asc') ? 'desc' : 'asc';
                    buySortKey = key;
                    updateSortHeaders('buy-orders-table', buySortKey, buySortDir);
                    applyFiltersWithWorker();
                };
            });
            if (sellThead) sellThead.querySelectorAll('th').forEach(th => {
                th.onclick = function() {
                    const key = this.getAttribute('data-sort-key');
                    if (!key) return;
                    sellSortDir = (sellSortKey === key && sellSortDir === 'asc') ? 'desc' : 'asc';
                    sellSortKey = key;
                    updateSortHeaders('sell-orders-table', sellSortKey, sellSortDir);
                    applyFiltersWithWorker();
                };
            });
        }

        function applyFiltersWithWorker() {
            const data = window.currentData || {};
            const orderAnalysis = data.order_analysis || {};
            const buyOrders = orderAnalysis.buy_orders || [];
            const sellOrders = orderAnalysis.sell_orders || [];
            const search = (lastFilter.search || '').toLowerCase();
            const status = lastFilter.status || '';
            const filteredBuy = buyOrders.filter(o => {
                const sm = !search || (o.symbol || '').toLowerCase().includes(search);
                const st = !status || (o.status || '') === status;
                return sm && st;
            });
            const filteredSell = sellOrders.filter(o => {
                const sm = !search || (o.symbol || '').toLowerCase().includes(search);
                const st = !status || (o.status || '') === status;
                return sm && st;
            });
            window.lastFilteredBuy = sortOrders(filteredBuy, buySortKey, buySortDir);
            window.lastFilteredSell = sortOrders(filteredSell, sellSortKey, sellSortDir);
            const totals = {
                totalBought: filteredBuy.reduce((s,o)=>s+(o.total_value||0),0),
                totalSold: filteredSell.reduce((s,o)=>s+(o.total_value||0),0),
                totalProfit: filteredSell.reduce((s,o)=>s+(o.total_value||0),0) - filteredBuy.reduce((s,o)=>s+(o.total_value||0),0)
            };
            renderFilteredTables(window.lastFilteredBuy, window.lastFilteredSell, totals);
        }

        function calculatePositions(orderAnalysis) {
            const bySymbol = {};
            (orderAnalysis.buy_orders || []).forEach(o => {
                const s = o.symbol || 'N/A';
                const qty = o.quantity || 0;
                const val = (o.price || 0) * qty;
                if (!bySymbol[s]) bySymbol[s] = { symbol: s, buyQty: 0, buyVal: 0, sellQty: 0, firstBuyDate: null };
                bySymbol[s].buyQty += qty;
                bySymbol[s].buyVal += val;
                const d = formatDate(o.date || '');
                const parsed = new Date(d);
                if (!isNaN(parsed.getTime())) {
                    if (!bySymbol[s].firstBuyDate || parsed < bySymbol[s].firstBuyDate) bySymbol[s].firstBuyDate = parsed;
                }
            });
            (orderAnalysis.sell_orders || []).forEach(o => {
                const s = o.symbol || 'N/A';
                const qty = o.quantity || 0;
                if (!bySymbol[s]) bySymbol[s] = { symbol: s, buyQty: 0, buyVal: 0, sellQty: 0, firstBuyDate: null };
                bySymbol[s].sellQty += qty;
            });
            const positions = Object.values(bySymbol).map(p => {
                const netQty = (p.buyQty || 0) - (p.sellQty || 0);
                const costBasis = netQty > 0 ? (p.buyVal || 0) / (p.buyQty || 1) : 0;
                const durDays = p.firstBuyDate ? Math.floor((new Date().getTime() - p.firstBuyDate.getTime()) / (1000*60*60*24)) : 0;
                return { symbol: p.symbol, quantity: netQty, costBasis, durationDays: durDays };
            }).filter(p => p.quantity > 0);
            return positions;
        }

        function renderPositions(positions, quotes) {
            const body = document.getElementById('positions-body');
            if (!positions || positions.length === 0) {
                body.innerHTML = '<tr><td colspan="7" style="padding:20px;text-align:center;color:#999;">No open positions</td></tr>';
                return;
            }
            const totalMV = positions.reduce((s, p) => {
                const price = quotes[p.symbol] || 0;
                return s + (price * p.quantity);
            }, 0);
            body.innerHTML = positions.map(p => {
                const price = quotes[p.symbol] || 0;
                const mv = price * p.quantity;
                const glPct = p.costBasis > 0 && price > 0 ? ((price - p.costBasis) / p.costBasis) * 100 : 0;
                const color = glPct >= 0 ? '#10b981' : '#ef4444';
                const relSize = totalMV > 0 ? (mv / totalMV) * 100 : 0;
                return `
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding:10px;font-weight:500;">${p.symbol}</td>
                        <td style="padding:10px;text-align:right;">${p.quantity.toFixed(2)}</td>
                        <td style="padding:10px;text-align:right;">$${p.costBasis.toFixed(2)}</td>
                        <td style="padding:10px;text-align:right;">$${price.toFixed(2)}</td>
                        <td style="padding:10px;text-align:right;">$${mv.toFixed(2)}</td>
                        <td style="padding:10px;text-align:right;color:${color};font-weight:500;">${glPct.toFixed(2)}%</td>
                        <td style="padding:10px;text-align:center;">${p.durationDays}d ¬∑ ${relSize.toFixed(1)}%</td>
                    </tr>
                `;
            }).join('');
        }

        function displayOrderAnalysis(orderAnalysis) {
            const stockList = document.getElementById('stock-list');
            stockList.innerHTML = '';
            const uniqueSymbols = [...new Set(orderAnalysis.buy_orders.map(o => o.symbol).concat(orderAnalysis.sell_orders.map(o => o.symbol)))].filter(Boolean).sort();
            window.availableSymbols = uniqueSymbols;
            uniqueSymbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                stockList.appendChild(option);
            });
            document.getElementById('order-tables').style.display = 'block';
        }

        function formatDate(dateStr) {
            if (!dateStr || dateStr === 'N/A' || dateStr === '') return 'N/A';
            
            // Convert to string if not already
            dateStr = String(dateStr).trim();
            
            // Try to format the full date (day, month, year)
            // Pattern 1: MM/DD/YYYY format
            const slashMatch = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if (slashMatch) {
                const month = parseInt(slashMatch[1]);
                const day = parseInt(slashMatch[2]);
                const year = parseInt(slashMatch[3]);
                
                // Check if it's MM/DD/YYYY (month <= 12) or DD/MM/YYYY
                if (month <= 12 && day <= 31) {
                    // Likely MM/DD/YYYY format
                    const date = new Date(year, month - 1, day);
                    return date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                } else {
                    // Likely DD/MM/YYYY format
                    const date = new Date(year, day - 1, month);
                    return date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                }
            }
            
            // Pattern 2: YYYY-MM-DD format
            const dashMatch = dateStr.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
            if (dashMatch) {
                const year = parseInt(dashMatch[1]);
                const month = parseInt(dashMatch[2]);
                const day = parseInt(dashMatch[3]);
                const date = new Date(year, month - 1, day);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            }
            
            // Pattern 3: Try JavaScript Date parsing
            try {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                }
            } catch (e) {
                // Continue to next method
            }
            
            // If all else fails, return as is
            return dateStr;
        }

        function displayOrderTables(orderAnalysis, searchSymbol, filterStatus) {
            console.log('displayOrderTables called with:', orderAnalysis, searchSymbol, filterStatus);
            const buyOrders = orderAnalysis.buy_orders || [];
            const sellOrders = orderAnalysis.sell_orders || [];
            
            console.log('Raw buy orders:', buyOrders.length);
            console.log('Raw sell orders:', sellOrders.length);
            
            // Filter by symbol and status
            const filteredBuyOrders = buyOrders.filter(order => {
                const statusMatch = !filterStatus || (order.status && order.status === filterStatus);
                const searchMatch = !searchSymbol || order.symbol.toLowerCase().includes(searchSymbol.toLowerCase());
                return statusMatch && searchMatch;
            });
            
            const filteredSellOrders = sellOrders.filter(order => {
                const statusMatch = !filterStatus || (order.status && order.status === filterStatus);
                const searchMatch = !searchSymbol || order.symbol.toLowerCase().includes(searchSymbol.toLowerCase());
                return statusMatch && searchMatch;
            });
            
            console.log('Filtered buy orders:', filteredBuyOrders.length);
            console.log('Filtered sell orders:', filteredSellOrders.length);
            
            // Recalculate KPIs based on filtered data
            const filteredTotalBought = filteredBuyOrders.reduce((sum, order) => sum + (order.total_value || 0), 0);
            const filteredTotalSold = filteredSellOrders.reduce((sum, order) => sum + (order.total_value || 0), 0);
            const filteredTotalProfit = filteredTotalSold - filteredTotalBought;
            
            // Update KPI values
            const profitValue = document.getElementById('total-profit');
            const boughtValue = document.getElementById('bought-total-value');
            const sellValue = document.getElementById('sell-total-value');
            
            profitValue.textContent = formatCurrency(filteredTotalProfit);
            profitValue.className = 'metric-value ' + (filteredTotalProfit >= 0 ? 'positive' : 'negative');
            
            boughtValue.textContent = formatCurrency(filteredTotalBought);
            sellValue.textContent = formatCurrency(filteredTotalSold);
            
            // Display buy orders
            const buyBody = document.getElementById('buy-orders-body');
            if (filteredBuyOrders.length === 0) {
                buyBody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #999;">No buy orders found</td></tr>';
            } else {
                buyBody.innerHTML = filteredBuyOrders.map(order => {
                    const dateValue = order.date || '';
                    const dayValue = formatDate(dateValue);
                    console.log('Buy order date:', dateValue, '-> formatted:', dayValue);
                    return `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; font-weight: 500;">${order.symbol || 'N/A'}</td>
                        <td style="padding: 10px; text-align: right;">$${(order.price || 0).toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right;">${(order.quantity || 0).toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right;">$${(order.total_value || 0).toFixed(2)}</td>
                        <td style="padding: 10px; text-align: center; color: #666; font-size: 0.9em;">${dayValue}</td>
                    </tr>
                `;
                }).join('');
            }
            
            // Display sell orders
            const sellBody = document.getElementById('sell-orders-body');
            if (filteredSellOrders.length === 0) {
                sellBody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #999;">No sell orders found</td></tr>';
            } else {
                sellBody.innerHTML = filteredSellOrders.map(order => {
                    const profit = order.profit || 0;
                    const dateValue = order.date || '';
                    const dayValue = formatDate(dateValue);
                    console.log('Sell order date:', dateValue, '-> formatted:', dayValue);
                    return `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; font-weight: 500;">${order.symbol || 'N/A'}</td>
                        <td style="padding: 10px; text-align: right;">$${(order.price || 0).toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right;">${(order.quantity || 0).toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right;">$${(order.total_value || 0).toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right; color: ${profit >= 0 ? '#10b981' : '#ef4444'}; font-weight: 500;">${formatCurrency(profit)}</td>
                        <td style="padding: 10px; text-align: center; color: #666; font-size: 0.9em;">${dayValue}</td>
                    </tr>
                `;
                }).join('');
            }
        }

        // Load data on page load
        loadData();
        
        // Add a test button for switching to orders view
        setTimeout(() => {
            console.log('Adding test button for orders view...');
            const testBtn = document.createElement('button');
            testBtn.textContent = 'Test Orders View';
            testBtn.style.position = 'fixed';
            testBtn.style.top = '10px';
            testBtn.style.right = '10px';
            testBtn.style.zIndex = '9999';
            testBtn.style.padding = '10px';
            testBtn.style.background = '#667eea';
            testBtn.style.color = 'white';
            testBtn.style.border = 'none';
            testBtn.style.borderRadius = '5px';
            testBtn.style.cursor = 'pointer';
            testBtn.onclick = () => {
                console.log('Test button clicked - switching to orders view');
                switchView('orders');
            };
            document.body.appendChild(testBtn);
            console.log('Test button added');
        }, 3000);

        // Enhanced Company Filter Component Integration
        class CompanyFilter {
            constructor() {
                console.log('CompanyFilter constructor called');
                this.companies = [];
                this.filteredCompanies = [];
                this.selectedCompanies = new Set();
                this.isOpen = false;
                this.isLoading = false;
                this.keyboardIndex = -1;
                this.searchTerm = '';
                this.dropdownSearchTerm = '';
                
                this.init();
            }

            init() {
                console.log('CompanyFilter init called');
                this.setupElements();
                this.setupEventListeners();
                this.loadCompanies();
                console.log('CompanyFilter init completed');
            }

            setupElements() {
                console.log('Setting up CompanyFilter elements...');
                this.elements = {
                    container: document.querySelector('.company-dropdown-container'),
                    searchInput: document.getElementById('company-search'),
                    clearBtn: document.getElementById('company-clear'),
                    toggleBtn: document.getElementById('company-dropdown-toggle'),
                    dropdown: document.getElementById('company-dropdown'),
                    dropdownSearchInput: document.getElementById('dropdown-search-input'),
                    dropdownContent: document.getElementById('company-dropdown-content'),
                    dropdownCount: document.getElementById('company-count'),
                    loading: document.getElementById('company-loading'),
                    clearAllBtn: document.getElementById('clear-all-companies'),
                    applyBtn: document.getElementById('apply-companies')
                };
                
                // Check if all elements are found
                Object.keys(this.elements).forEach(key => {
                    if (!this.elements[key]) {
                        console.warn(`CompanyFilter element not found: ${key}`);
                    }
                });
                
                console.log('CompanyFilter elements setup completed');
            }

            setupEventListeners() {
                // Main search input
                this.elements.searchInput.addEventListener('input', (e) => {
                    this.handleSearchInput(e.target.value);
                });

                this.elements.searchInput.addEventListener('focus', () => {
                    this.openDropdown();
                });

                this.elements.searchInput.addEventListener('keydown', (e) => {
                    this.handleKeyboardNavigation(e);
                });

                // Clear button
                this.elements.clearBtn.addEventListener('click', () => {
                    this.clearSearch();
                });

                // Toggle button
                this.elements.toggleBtn.addEventListener('click', () => {
                    this.toggleDropdown();
                });

                // Dropdown search
                this.elements.dropdownSearchInput.addEventListener('input', (e) => {
                    this.filterDropdownOptions(e.target.value);
                });

                // Clear all and apply buttons
                this.elements.clearAllBtn.addEventListener('click', () => {
                    this.clearAllSelections();
                });

                this.elements.applyBtn.addEventListener('click', () => {
                    this.applyFilter();
                });

                // Click outside to close
                document.addEventListener('click', (e) => {
                    if (!this.elements.container.contains(e.target)) {
                        this.closeDropdown();
                    }
                });

                // Escape key to close
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.isOpen) {
                        this.closeDropdown();
                    }
                });
            }

            async loadCompanies() {
                this.setLoading(true);
                
                try {
                    // Try to get companies from existing orders data first
                    const companies = await this.extractCompaniesFromOrders();
                    
                    if (companies.length === 0) {
                        // Fallback to mock data if no companies found
                        this.companies = this.getMockCompanies();
                    } else {
                        this.companies = companies;
                    }
                    
                    this.filteredCompanies = [...this.companies];
                    this.updateDropdownCount();
                    this.renderDropdownOptions();
                    
                } catch (error) {
                    console.error('Error loading companies:', error);
                    this.companies = this.getMockCompanies();
                    this.filteredCompanies = [...this.companies];
                    this.renderDropdownOptions();
                } finally {
                    this.setLoading(false);
                }
            }

            async extractCompaniesFromOrders() {
                // Extract unique companies from existing orders data
                const ordersData = DashboardState.ordersData;
                const companies = new Map();
                
                if (ordersData.buy && ordersData.sell) {
                    const allOrders = [...ordersData.buy, ...ordersData.sell];
                    
                    allOrders.forEach(order => {
                        if (order.symbol && !companies.has(order.symbol)) {
                            companies.set(order.symbol, {
                                symbol: order.symbol,
                                name: order.symbol, // Will be enhanced with real company names
                                sector: this.getSectorForSymbol(order.symbol)
                            });
                        }
                    });
                }
                
                return Array.from(companies.values()).sort((a, b) => a.symbol.localeCompare(b.symbol));
            }

            getMockCompanies() {
                return [
                    { symbol: 'AAPL', name: 'Apple Inc.', sector: 'Technology' },
                    { symbol: 'GOOGL', name: 'Alphabet Inc.', sector: 'Technology' },
                    { symbol: 'MSFT', name: 'Microsoft Corporation', sector: 'Technology' },
                    { symbol: 'AMZN', name: 'Amazon.com Inc.', sector: 'Consumer Discretionary' },
                    { symbol: 'TSLA', name: 'Tesla Inc.', sector: 'Consumer Discretionary' },
                    { symbol: 'META', name: 'Meta Platforms Inc.', sector: 'Technology' },
                    { symbol: 'NVDA', name: 'NVIDIA Corporation', sector: 'Technology' },
                    { symbol: 'JPM', name: 'JPMorgan Chase & Co.', sector: 'Financials' },
                    { symbol: 'JNJ', name: 'Johnson & Johnson', sector: 'Healthcare' },
                    { symbol: 'V', name: 'Visa Inc.', sector: 'Financials' },
                    { symbol: 'PG', name: 'Procter & Gamble Co.', sector: 'Consumer Staples' },
                    { symbol: 'HD', name: 'Home Depot Inc.', sector: 'Consumer Discretionary' },
                    { symbol: 'UNH', name: 'UnitedHealth Group Inc.', sector: 'Healthcare' },
                    { symbol: 'MA', name: 'Mastercard Inc.', sector: 'Financials' },
                    { symbol: 'BAC', name: 'Bank of America Corp.', sector: 'Financials' },
                    { symbol: 'DIS', name: 'Walt Disney Co.', sector: 'Communication Services' },
                    { symbol: 'ADBE', name: 'Adobe Inc.', sector: 'Technology' },
                    { symbol: 'NFLX', name: 'Netflix Inc.', sector: 'Communication Services' },
                    { symbol: 'CRM', name: 'Salesforce Inc.', sector: 'Technology' },
                    { symbol: 'ACN', name: 'Accenture plc', sector: 'Information Technology' }
                ];
            }

            getSectorForSymbol(symbol) {
                const sectorMap = {
                    'AAPL': 'Technology', 'GOOGL': 'Technology', 'MSFT': 'Technology',
                    'AMZN': 'Consumer Discretionary', 'TSLA': 'Consumer Discretionary',
                    'META': 'Technology', 'NVDA': 'Technology', 'JPM': 'Financials',
                    'JNJ': 'Healthcare', 'V': 'Financials', 'PG': 'Consumer Staples',
                    'HD': 'Consumer Discretionary', 'UNH': 'Healthcare', 'MA': 'Financials',
                    'BAC': 'Financials', 'DIS': 'Communication Services', 'ADBE': 'Technology',
                    'NFLX': 'Communication Services', 'CRM': 'Technology', 'ACN': 'Information Technology'
                };
                return sectorMap[symbol] || 'Other';
            }

            handleSearchInput(value) {
                this.searchTerm = value;
                this.elements.clearBtn.style.display = value.length > 0 ? 'flex' : 'none';
                
                if (value.length > 0 && !this.isOpen) {
                    this.openDropdown();
                }
                
                this.filterDropdownOptions(value);
            }

            filterDropdownOptions(searchTerm) {
                this.dropdownSearchTerm = searchTerm.toLowerCase();
                
                if (!searchTerm) {
                    this.filteredCompanies = [...this.companies];
                } else {
                    this.filteredCompanies = this.companies.filter(company => 
                        company.name.toLowerCase().includes(this.dropdownSearchTerm) ||
                        company.symbol.toLowerCase().includes(this.dropdownSearchTerm) ||
                        company.sector.toLowerCase().includes(this.dropdownSearchTerm)
                    );
                }
                
                this.renderDropdownOptions();
            }

            renderDropdownOptions() {
                const content = this.elements.dropdownContent;
                content.innerHTML = '';
                
                if (this.filteredCompanies.length === 0) {
                    content.innerHTML = '<div class="no-results">No companies found</div>';
                    return;
                }
                
                this.filteredCompanies.forEach((company, index) => {
                    const option = document.createElement('div');
                    option.className = 'company-option';
                    option.setAttribute('role', 'option');
                    option.setAttribute('aria-selected', this.selectedCompanies.has(company.symbol));
                    option.setAttribute('tabindex', '0');
                    option.dataset.index = index;
                    option.dataset.symbol = company.symbol;
                    
                    option.innerHTML = `
                        <div class="company-checkbox"></div>
                        <div class="company-info">
                            <div class="company-name">${company.name}</div>
                            <div class="company-symbol">${company.symbol}</div>
                            <div class="company-sector">${company.sector}</div>
                        </div>
                    `;
                    
                    option.addEventListener('click', () => {
                        this.toggleCompanySelection(company.symbol);
                    });
                    
                    option.addEventListener('keydown', (e) => {
                        this.handleOptionKeyboard(e, index);
                    });
                    
                    if (this.selectedCompanies.has(company.symbol)) {
                        option.classList.add('selected');
                    }
                    
                    content.appendChild(option);
                });
                
                this.updateDropdownCount();
            }

            toggleCompanySelection(symbol) {
                if (this.selectedCompanies.has(symbol)) {
                    this.selectedCompanies.delete(symbol);
                } else {
                    this.selectedCompanies.add(symbol);
                }
                
                this.updateOptionSelection(symbol);
                this.updateApplyButton();
            }

            updateOptionSelection(symbol) {
                const option = this.elements.dropdownContent.querySelector(`[data-symbol="${symbol}"]`);
                if (option) {
                    const isSelected = this.selectedCompanies.has(symbol);
                    option.classList.toggle('selected', isSelected);
                    option.setAttribute('aria-selected', isSelected);
                }
            }

            handleKeyboardNavigation(e) {
                const options = this.elements.dropdownContent.querySelectorAll('.company-option');
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        this.keyboardIndex = Math.min(this.keyboardIndex + 1, options.length - 1);
                        this.updateKeyboardSelection(options);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        this.keyboardIndex = Math.max(this.keyboardIndex - 1, 0);
                        this.updateKeyboardSelection(options);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (this.keyboardIndex >= 0 && options[this.keyboardIndex]) {
                            options[this.keyboardIndex].click();
                        }
                        break;
                    case 'Escape':
                        this.closeDropdown();
                        break;
                }
            }

            handleOptionKeyboard(e, index) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.toggleCompanySelection(this.filteredCompanies[index].symbol);
                }
            }

            updateKeyboardSelection(options) {
                options.forEach((option, index) => {
                    option.classList.toggle('keyboard-selected', index === this.keyboardIndex);
                    if (index === this.keyboardIndex) {
                        option.focus();
                    }
                });
            }

            openDropdown() {
                this.isOpen = true;
                this.elements.dropdown.classList.add('active');
                this.elements.toggleBtn.classList.add('active');
                this.elements.searchInput.setAttribute('aria-expanded', 'true');
                this.elements.dropdownSearchInput.focus();
                this.keyboardIndex = -1;
            }

            closeDropdown() {
                this.isOpen = false;
                this.elements.dropdown.classList.remove('active');
                this.elements.toggleBtn.classList.remove('active');
                this.elements.searchInput.setAttribute('aria-expanded', 'false');
                this.keyboardIndex = -1;
            }

            toggleDropdown() {
                if (this.isOpen) {
                    this.closeDropdown();
                } else {
                    this.openDropdown();
                }
            }

            clearSearch() {
                this.elements.searchInput.value = '';
                this.searchTerm = '';
                this.elements.clearBtn.style.display = 'none';
                this.filterDropdownOptions('');
                this.applyFilter();
            }

            clearAllSelections() {
                this.selectedCompanies.clear();
                this.elements.dropdownContent.querySelectorAll('.company-option').forEach(option => {
                    option.classList.remove('selected');
                    option.setAttribute('aria-selected', 'false');
                });
                this.updateApplyButton();
            }

            updateDropdownCount() {
                this.elements.dropdownCount.textContent = this.filteredCompanies.length;
            }

            updateApplyButton() {
                const hasSelection = this.selectedCompanies.size > 0;
                this.elements.applyBtn.style.opacity = hasSelection ? '1' : '0.6';
                this.elements.applyBtn.style.cursor = hasSelection ? 'pointer' : 'not-allowed';
            }

            applyFilter() {
                const selectedArray = Array.from(this.selectedCompanies);
                
                // Update main search input with selected companies
                if (selectedArray.length > 0) {
                    this.elements.searchInput.value = selectedArray.join(', ');
                    this.elements.searchInput.placeholder = `${selectedArray.length} companies selected`;
                } else {
                    this.elements.searchInput.value = '';
                    this.elements.searchInput.placeholder = 'Search company...';
                }
                
                // Apply filter to dashboard
                DashboardState.updateFilters({ companies: selectedArray });
                
                // Close dropdown
                this.closeDropdown();
                
                console.log('Applied company filter:', selectedArray);
            }

            setLoading(loading) {
                this.isLoading = loading;
                this.elements.loading.style.display = loading ? 'flex' : 'none';
                
                if (loading) {
                    this.elements.dropdownContent.style.display = 'none';
                } else {
                    this.elements.dropdownContent.style.display = 'block';
                }
            }
        }

        // Initialize the enhanced company filter when orders view is loaded
        let companyFilter = null;
        
        function initializeCompanyFilter() {
            console.log('Initializing company filter...');
            if (!companyFilter) {
                try {
                    companyFilter = new CompanyFilter();
                    console.log('Company filter initialized successfully');
                } catch (error) {
                    console.error('Error initializing company filter:', error);
                }
            } else {
                console.log('Company filter already initialized');
            }
        }

        // Make it globally accessible for integration
        window.CompanyFilter = CompanyFilter;
        window.companyFilter = companyFilter;
        
        // Test function to check if company filter elements exist
        window.testCompanyFilterElements = function() {
            console.log('Testing company filter elements...');
            const elements = {
                container: document.querySelector('.company-dropdown-container'),
                searchInput: document.getElementById('company-search'),
                clearBtn: document.getElementById('company-clear'),
                toggleBtn: document.getElementById('company-dropdown-toggle'),
                dropdown: document.getElementById('company-dropdown'),
                dropdownSearchInput: document.getElementById('dropdown-search-input'),
                dropdownContent: document.getElementById('company-dropdown-content'),
                dropdownCount: document.getElementById('company-count'),
                loading: document.getElementById('company-loading'),
                clearAllBtn: document.getElementById('clear-all-companies'),
                applyBtn: document.getElementById('apply-companies')
            };
            
            Object.keys(elements).forEach(key => {
                console.log(`${key}: ${elements[key] ? 'FOUND' : 'NOT FOUND'}`);
            });
        };
    </script>
<!-- Removed stray duplicated script content appended after closing tags -->
</body>
</html>
